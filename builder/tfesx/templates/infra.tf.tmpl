###########################################################
# LAFORGE GENERATED TERRAFORM CONFIGURATION
# -- WARNING --
# This file is automatically generated. Do not edit it's
# contents directly. Use Laforge and re build this file.
###########################################################

provider "vsphere" {
	vsphere_server = "{{ index $.Build.Config "vsphere_server" }}"
	user = "{{ index $.Build.Config "vsphere_user" }}"
    password = "{{ index $.Build.Config "vsphere_password" }}"
	allow_unverified_ssl = true
}

variable "vmos" {
	type = "map"
	default = {
		"ad" = "w
	}
}

# hard corded dc
data "vsphere_datacenter" "dc" {
	name = "ESXI"
}

# hard coded datastore
data "vsphere_datastore" "datastore" {
	name = "datastore1"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# hard corded resource pool
data "vsphere_resource_pool" "pool" {
	name = "Resources"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# hard coded distributed switch
data "vsphere_distributed_virtual_switch" "dvs" {
	name = "DSwitch"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# hard coded template reference
data "vsphere_virtual_machine" "ubuntu18" {
	name = "Template-Ubuntu 18"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# hard coded template reference
data "vsphere_virtual_machine" "win10" {
	name = "Template-Windows 10"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# hard coded template reference
data "vsphere_virtual_machine" "w2k16" {
	name = "Template-Windows Server 2016"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# loop to create port groups
{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
{{ $net := $pnet.Network }}
{{ $netname := $net.Path }}
resource "vsphere_distributed_port_group" "pg-t{{ $.Team.TeamNumber }}-{{ $net.Base }}" {
 	name = "t{{ $.Team.TeamNumber }}-{{ $net.Base }}"
 	distributed_virtual_switch_uuid = "${data.vsphere_distributed_virtual_switch.dvs.id}"
 	vlan_id = 100
}
{{ end }}

# make parent folder
resource "vsphere_folder" "team_{{ $.Team.TeamNumber }}" {
	path = "Team {{ $.Team.TeamNumber }}"
	type = "vm"
	datacenter_id = "${data.vsphere_datacenter.dc.id}"
}

# loop to create sub folders
{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
{{ $net := $pnet.Network }}
{{ $netname := $net.Path }}
resource "vsphere_folder" "team_{{ $.Team.TeamNumber }}_{{ $net.Base }}" {
 	path = "${vsphere_folder.team_{{ $.Team.TeamNumber }}_{{ $net.Base }}" 
	type = "vm"
	datacenter_id = "${data.vsphere_datacenter_dc.id}"
}
{{ end }}

# loop virtual machines
{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
  {{ $netobj := $pnet.Network }}
  {{ range $phostid, $phost := $pnet.ProvisionedHosts }}
    {{ $host := $phost.Host }}
    {{ if eq $host.Base "ns01" }}
      {{ $dns_resource_name = printf "%s-t%d-%s-%s" $.Environment.Base $.Team.TeamNumber $netobj.Base $host.Base }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range $pnetid, $pnet := $.Team.ProvisionedNetworks }}
  {{ $netobj := $pnet.Network }}
  {{ range $phostid, $phost := $pnet.ProvisionedHosts }}
    {{ $host := $phost.Host }}
    {{ $resource_name := printf "%s-t%d-%s-%s" $.Environment.Base $.Team.TeamNumber $netobj.Base $host.Base }}

# hard coded vm specifications, use map
    resource "vsphere_virtual_machine" "{{ $resource_name }}" {
      name = "{{ $resource_name }}"
	  resource_pool_id = "${data.vsphere_resource_pool.pool.id}"
	  datastore_id = "${data.vsphere_datastore.datastore.id}"
	  num_cpus = 2
	  memory = 16384
	  scsi_type = "${data.vsphere_virtual_machine.${var.vmos["{{ $host.OS }}"]}.scsi_type}"
	  firmware = "${data.vsphere_virtual_machine.${var.vmos["{{ $host.OS }}"]}.firmware}"
	  folder = "${vsphere_folder.team_{{ $.Team.TeamNumber }}}"
	  network_interface {
		network_id = "${vsphere_distributed_port_group.pg_team_{{ $.Team.TeamNumber }}_{{ $host.Base }}.id}}"
	    adapter_type = "${data.vsphere_virtual_machine.${var.vmos["{{ $host.OS }}"]}.network_interface_types[0]}"
	  }
	  disk {
		size = "${data.vsphere_virtual_machine.${var.vmos["{{ $host.OS }}"]}.disks.0.size}"
		label = "team_{{ $.Team.TeamNumber }}_{{ $netobj.Base }}.vmdk"
      }
	  clone {
		template_uuid = "${data.vsphere_virtual_machine.${var.vmos["{{ $host.OS }}"]}.id}"
		timeout = 60
	  }
  {{ end }}
{{ end }}

